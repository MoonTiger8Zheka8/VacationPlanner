@page "/assistant"
@rendermode InteractiveServer
@implements IDisposable

@inject IJSRuntime JS
@inject VacationPlanner.Application.Interfaces.IVoiceCommandParser Parser
@inject VacationPlanner.Application.Interfaces.IVacationPlannerService PlannerService

@using VacationPlanner.Domain.Models
@using VacationPlanner.Components.Shared
<h3>–ú—É–ª—å—Ç–∏–º–µ–¥—ñ–π–Ω–∏–π –≥–æ–ª–æ—Å–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫</h3>

<div class="card p-3 mb-3">
    <div class="d-flex gap-2">
        <button class="btn btn-primary" @onclick="StartVoice">
            üé§ –°–∫–∞–∑–∞—Ç–∏ –∑–∞–ø–∏—Ç
        </button>

        <button class="btn btn-success" @onclick="SpeakPlan" disabled="@(plan is null)">
            üîä –û–∑–≤—É—á–∏—Ç–∏ –ø–ª–∞–Ω
        </button>
    </div>

    <p class="mt-3 mb-0"><b>–†–æ–∑–ø—ñ–∑–Ω–∞–Ω–∏–π —Ç–µ–∫—Å—Ç:</b> @recognizedText</p>
</div>

@if (request is not null)
{
    <div class="card p-3 mb-3">
        <h5>–†–æ–∑–ø—ñ–∑–Ω–∞–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏</h5>
        <ul class="mb-0">
            <li><b>–ú—ñ—Å—Ü–µ:</b> @request.Destination</li>
            <li><b>–ö-—Ç—å –¥–Ω—ñ–≤:</b> @request.Days</li>
            <li><b>–ë—é–¥–∂–µ—Ç:</b> @request.Budget –≥—Ä–Ω</li>
            <li><b>–õ—é–¥–µ–π:</b> @request.People</li>
            <li><b>–¢–∏–ø:</b> @request.Type</li>
        </ul>
    </div>
}

@if (plan is not null)
{
    <h4>–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –ø–ª–∞–Ω</h4>

    <p><b>–ó–∞–≥–∞–ª—å–Ω–∞ –æ—Ü—ñ–Ω–æ—á–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å:</b> @plan.TotalEstimatedCost –≥—Ä–Ω</p>

    @foreach (var day in plan.Days)
    {
        <div class="card p-3 mb-2">
            <h5>@day.Title</h5>
            <p><b>–û—Ü—ñ–Ω–æ—á–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏:</b> @day.EstimatedCost –≥—Ä–Ω</p>

            <div class="row g-3">
                @foreach (var place in day.Places)
                {
                    <div class="col-md-6 col-lg-4">
                        <PlaceCard Place="place" ShowMapButton="false" />
                    </div>
                }
            </div>
        </div>
    }
}

@code {
    private string recognizedText = "";

    private VacationRequest? request;
    private VacationPlan? plan;

    private DotNetObjectReference<Assistant>? objRef;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
        }
    }

    private async Task StartVoice()
    {
        if (objRef is null)
            objRef = DotNetObjectReference.Create(this);

        await JS.InvokeVoidAsync("voiceAssistant.startRecognition", objRef);
    }

    [JSInvokable]
    public async Task OnSpeechRecognized(string text)
{
    recognizedText = text;

    request = Parser.Parse(recognizedText);
    plan = await PlannerService.GeneratePlanAsync(request);

    StateHasChanged();
}

    private async Task SpeakPlan()
    {
        if (plan is null) return;

        // –ö–æ—Ä–æ—Ç–∫–∏–π –ø—ñ–¥—Å—É–º–æ–∫
        var speech = $"–Ø —Å—Ç–≤–æ—Ä–∏–≤ –ø–ª–∞–Ω –≤—ñ–¥–ø—É—Å—Ç–∫–∏ —É {plan.Request.Destination} –Ω–∞ {plan.Request.Days} –¥–Ω—ñ–≤. " +
                     $"–û—Ü—ñ–Ω–æ—á–Ω–∏–π –±—é–¥–∂–µ—Ç {plan.TotalEstimatedCost} –≥—Ä–∏–≤–µ–Ω—å. ";

        //
        foreach (var day in plan.Days)
            speech += $"{day.Title}. ";

        await JS.InvokeVoidAsync("voiceAssistant.speak", speech);
    }
    private async Task ShowPlaceOnMap(VacationPlanner.Domain.Models.PlaceInfo place)
    {
        if (place.Lat is null || place.Lon is null) return;

        await JS.InvokeVoidAsync("leafletMap.panTo", place.Lat.Value, place.Lon.Value, place.Name);
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
